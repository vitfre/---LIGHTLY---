/*
 * sensors.h
 *
 * Created: 30.04.2014 19:04:14
 *  Author: vmk
 */ 

#ifndef	SENSORS_H_
#define	SENSORS_H_
//---------------------------------------------------------------------------------------
#include <avr/io.h>
//---------------------------------------------------------------------------------------
#include "bit_macros.h"
//---------------------------------------------------------------------------------------
#define MASK1_SENSORS 			(1<<ONE)|(1<<TWO)|(1<<THREE)|(1<<FOUR)|(1<<FIVE)|(1<<SIX)|(1<<SEVEN)|(1<<EIGHT)
#define MASK2_SENSORS 			(1<<NINE)|(1<<TEN)|(1<<ELEVEN)|(1<<TWELWE)|(1<<THIRTEN)|(1<<FOURTEEN)|(1<<FIFTEEN)|(1<<SIXTEN)
#define MASK3_SENSORS 			(1<<SEVENTEEN)|(1<<EIGHTTEEN)
//---------------------------------------------------------------------------------------
//порты, к которым подключены датчики
#define PORT1_SENSORS 			PORTE
#define PIN1_SENSORS 			PINE
#define DDRX1_SENSORS 			DDRE

#define PORT2_SENSORS 			PORTB
#define PIN2_SENSORS 			PINB
#define DDRX2_SENSORS 			DDRB

#define PORT3_SENSORS 			PORTD
#define PIN3_SENSORS 			PIND
#define DDRX3_SENSORS 			DDRD
//---------------------------------------------------------------------------------------
//номера выводов, к которым подключены датчики
#define ONE 					0UL
#define TWO 					1UL
#define THREE					2UL
#define FOUR 					3UL
#define FIVE 					4UL
#define SIX 					5UL
#define SEVEN 					6UL
#define EIGHT					7UL

#define NINE 					0UL
#define TEN 					1UL
#define ELEVEN 					2UL
#define TWELWE 					3UL
#define THIRTEN					4UL
#define FOURTEEN 				5UL
#define FIFTEEN 				6UL
#define SIXTEN					7UL

#define SEVENTEEN 				0UL
#define EIGHTTEEN 				1UL
//---------------------------------------------------------------------------------------
//коды, которые будут записываться в буфер
#define SENS_NULL      			0UL
#define SENS_TRIG				1UL
//---------------------------------------------------------------------------------------
unsigned char o_trig = 0;
//---------------------------------------------------------------------------------------
unsigned char old_stage[18] = {0};
unsigned int active_sensors[18] = {0};
/**************************************************************************
*   Function name : SENS_Init
*   Returns :       нет
*   Parameters :    нет
*   Purpose :       инициализация портов ввода/вывода
*                   вызывается обычно в начале main`a
****************************************************************************/
void SENS_Init(void)
{
	DDRX1_SENSORS &= ~(MASK1_SENSORS);
	PORT1_SENSORS |= MASK1_SENSORS;
	DDRX2_SENSORS &= ~(MASK2_SENSORS);
	PORT2_SENSORS |= MASK2_SENSORS;
	DDRX3_SENSORS &= ~(MASK3_SENSORS);
	PORT3_SENSORS |= MASK3_SENSORS;
};
/**************************************************************************
*   Function name : SENS_Debrief
*   Returns :       нет
*   Parameters :    нет
*   Purpose :       опрашивает датчики. вызывается обычно из прерывания
****************************************************************************/
void SENS_Debrief(void)
{
	//опрос выводов мк
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[0]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN1_SENSORS)>>(ONE))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[0]=SENS_TRIG;
			active_sensors[0]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	} 
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN1_SENSORS)>>(ONE))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[0]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[1]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN1_SENSORS)>>(TWO))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[1]=SENS_TRIG;
			active_sensors[1]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN1_SENSORS)>>(TWO))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[1]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[2]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN1_SENSORS)>>(THREE))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[2]=SENS_TRIG;
			active_sensors[2]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN1_SENSORS)>>(THREE))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[2]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[3]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN1_SENSORS)>>(FOUR))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[3]=SENS_TRIG;
			active_sensors[3]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN1_SENSORS)>>(FOUR))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[3]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[4]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN1_SENSORS)>>(FIVE))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[4]=SENS_TRIG;
			active_sensors[4]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN1_SENSORS)>>(FIVE))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[4]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[5]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN1_SENSORS)>>(SIX))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[5]=SENS_TRIG;
			active_sensors[5]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN1_SENSORS)>>(SIX))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[5]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[6]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN1_SENSORS)>>(SEVEN))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[6]=SENS_TRIG;
			active_sensors[6]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN1_SENSORS)>>(SEVEN))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[6]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[7]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN1_SENSORS)>>(EIGHT))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[7]=SENS_TRIG;
			active_sensors[7]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN1_SENSORS)>>(EIGHT))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[7]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[8]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN2_SENSORS)>>(NINE))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[8]=SENS_TRIG;
			active_sensors[8]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN2_SENSORS)>>(NINE))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[8]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[9]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN2_SENSORS)>>(TEN))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[9]=SENS_TRIG;
			active_sensors[9]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN2_SENSORS)>>(TEN))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[9]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[10]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN2_SENSORS)>>(ELEVEN))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[10]=SENS_TRIG;
			active_sensors[10]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN2_SENSORS)>>(ELEVEN))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[10]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[11]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN2_SENSORS)>>(TWELWE))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[11]=SENS_TRIG;
			active_sensors[11]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN2_SENSORS)>>(TWELWE))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[11]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[12]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN2_SENSORS)>>(THIRTEN))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[12]=SENS_TRIG;
			active_sensors[12]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN2_SENSORS)>>(THIRTEN))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[12]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[13]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN2_SENSORS)>>(FOURTEEN))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[13]=SENS_TRIG;
			active_sensors[13]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN2_SENSORS)>>(FOURTEEN))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[13]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[14]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN2_SENSORS)>>(FIFTEEN))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[14]=SENS_TRIG;
			active_sensors[14]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN2_SENSORS)>>(FIFTEEN))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[14]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[15]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN2_SENSORS)>>(SIXTEN))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[15]=SENS_TRIG;
			active_sensors[15]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN2_SENSORS)>>(SIXTEN))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[15]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[16]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN3_SENSORS)>>(SEVENTEEN))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[16]=SENS_TRIG;
			active_sensors[16]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN3_SENSORS)>>(SEVENTEEN))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[16]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
	if (old_stage[17]==0)
	{
		//---------------------------------------------------------------------------------------
		if (((PIN3_SENSORS)>>(EIGHTTEEN))&1)
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			old_stage[17]=SENS_TRIG;
			active_sensors[17]++;
			o_trig = 0x01;
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	}
	else
	{
		//---------------------------------------------------------------------------------------
		if (((PIN3_SENSORS)>>(EIGHTTEEN))&1)
		{
			//---------------------------------------------------------------------------------------
			old_stage[17]=SENS_NULL;
			//---------------------------------------------------------------------------------------
		}
		else
		{
			//---------------------------------------------------------------------------------------
			//---------------------------------------------------------------------------------------
		};
		//---------------------------------------------------------------------------------------
	};
	//---------------------------------------------------------------------------------------
	//---------------------------------------------------------------------------------------
};
/**************************************************************************
*   Function name : GET_trig
*   Returns :       возвращает сработал ли какой нибуть датчик
*   Parameters :    нет
*   Purpose :       возвращает сработал ли какой нибуть датчик
*                   при этом буфер очищается
*                   вызывается обычно в main`e в цикле while
*
****************************************************************************/
unsigned char GET_trig(void)
{
	unsigned char trig = o_trig;
	o_trig = 0;
	return trig;
};
#endif //SENSORS_H_
